/*! Spectrum4Leaflet 02-02-2015 */
var Spectrum4Leaflet={Version:"0.1",Services:{},Layers:{}};"undefined"!=typeof window&&window.L&&(window.L.spectrum4L=Spectrum4Leaflet),Spectrum4Leaflet.Util={},Spectrum4Leaflet.Request={_createRequest:function(a,b){var c=new XMLHttpRequest;return c.onerror=function(){a.call(b,{error:{code:500,message:"XMLHttpRequest error"}},null)},c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{var f=this.getResponseHeader("content-type");d="application/json"==f?JSON.parse(c.responseText):c.responseText}catch(g){d=null,e={code:500,message:"Could not parse response as JSON."}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c},get:function(a,b,c){var d=this._createRequest(b,c);return d.open("GET",a,!0),d.send(null),d},post:function(a,b,c,d){var e=this._createRequest(c,d);return e.open("POST",a,!0),e.setRequestHeader("Content-Type","application/json"),e.send(b),e}},Spectrum4Leaflet.Services.Operation=L.Class.extend({options:{forcePost:!1,paramsSeparator:";",queryStartCharacter:";"},initialize:function(a,b){this.options.getParams={},this.options.postParams={},b=b||{},b.name=a,L.setOptions(this,b)},getUrlQuery:function(){var a=[],b=this.options.getParams;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];a.push(c+"="+encodeURIComponent(d))}var e=this.options.name;return a.length>0&&(e+=this.options.queryStartCharacter+a.join(this.options.paramsSeparator)),e},getPostData:function(){return JSON.stringify(this.options.postParams)},isPostOperation:function(){return 0!==Object.keys(this.options.postParams).length|this.options.forcePost}}),Spectrum4Leaflet.Services.Service=L.Class.extend({options:{},initialize:function(a,b){b=b||{},b.url=a,L.Util.setOptions(this,b)},startRequest:function(a,b,c){var d=this.getUrl(a);return a.isPostOperation()?Spectrum4Leaflet.Request.post(d,a.getPostData(),b,c):Spectrum4Leaflet.Request.get(d,b,c)},getUrl:function(a){var b=this.clearParam(a.getUrlQuery()),c="/"===this.options.url.slice(-1)?"":"/";return this.options.url+c+b},clearParam:function(a){return"/"===a[0]?a.substring(1):a}}),Spectrum4Leaflet.Services.MapService=Spectrum4Leaflet.Services.Service.extend({listNamedLayers:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("layers.json");this._addResolutionAndLocale(d,null,a),this.startRequest(d,b,c)},describeNamedLayer:function(a,b,c,d){var e=new Spectrum4Leaflet.Services.Operation("layers/"+this.clearParam(a)+".json");this._addResolutionAndLocale(e,null,b),this.startRequest(e,c,d)},describeNamedLayers:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("layers.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");e.length<1e3?(d.options.getParams.q="describe",d.options.getParams.layers=e):d.options.postParams={Layers:a},this.startRequest(d,b,c)},listNamedMaps:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("maps.json");this._addResolutionAndLocale(d,null,a),this.startRequest(d,b,c)},describeNamedMap:function(a,b,c,d){var e=new Spectrum4Leaflet.Services.Operation("maps/"+this.clearParam(a)+".json");this._addResolutionAndLocale(e,null,b),this.startRequest(e,c,d)},describeNamedMaps:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("maps.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");e.length<1e3?(d.options.getParams.q="describe",d.options.getParams.maps=e):d.options.postParams={Maps:a},this.startRequest(d,b,c)},_createRenderOperation:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=new Spectrum4Leaflet.Services.Operation("maps/"+this.clearParam(a)+"/image."+b);return q.options.getParams.w=c,q.options.getParams.h=d,e?q.options.getParams.b=e.join(",")+","+j:q.options.getParams.c=f+","+g+","+j,h&&(q.options.getParams.s=h),i&&(q.options.getParams.z=i),this._addResolutionAndLocale(q,k,l),m&&(q.options.getParams.rd=m),n&&(q.options.getParams.bc=n),o&&(q.options.getParams.bc=n),p&&(q.options.postParams=p),q},_addResolutionAndLocale:function(a,b,c){b&&(a.options.getParams.r=b),c&&(a.options.getParams.l=c)},renderMapByBounds:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=this._createRenderOperation(a,b,c,d,e,null,null,null,null,f,g,h,i,j,k);this.startRequest(o,m,n)},getUrlRenderMapByBounds:function(a,b,c,d,e,f,g,h,i,j,k){var l=this._createRenderOperation(a,b,c,d,e,null,null,null,null,f,g,h,i,j,k);return this.getUrl(l)},renderMapByCenterScale:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this._createRenderOperation(a,b,c,d,null,e,f,g,null,h,i,j,k,l,m);this.startRequest(q,o,p)},getUrlRenderMapByCenterScale:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this._createRenderOperation(a,b,c,d,null,e,f,g,null,h,i,j,k,l,m);return this.getUrl(n)},renderMapByCenterZoom:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this._createRenderOperation(a,b,c,d,null,e,f,null,g,h,i,j,k,l,m);this.startRequest(q,o,p)},getUrlRenderMapByCenterZoom:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this._createRenderOperation(a,b,c,d,null,e,f,null,g,h,i,j,k,l,m);return this.getUrl(n)},getLegendForMap:function(a,b,c,d,e,f,g,h,i){var j=new Spectrum4Leaflet.Services.Operation("maps/"+this.clearParam(a)+"/legend.json");j.options.getParams.w=b,j.options.getParams.h=c,j.options.getParams.t=d,this._addResolutionAndLocale(j,e,f),g&&(j.options.getParams["?inlineSwatch"]=g),this.startRequest(j,h,i)},getSwatchForLayer:function(a,b,c,d,e,f,g,h,i,j){var k=new Spectrum4Leaflet.Services.Operation("maps/"+this.clearParam(a)+"/legends/"+b+"/rows/"+c+"/swatch/"+d+"x"+e+"."+f);this._addResolutionAndLocale(k,g,h),this.startRequest(k,i,j)},getUrlSwatchForLayer:function(a,b,c,d,e,f,g,h){var i=new Spectrum4Leaflet.Services.Operation("maps/"+this.clearParam(a)+"/legends/"+b+"/rows/"+c+"/swatch/"+d+"x"+e+"."+f);return this._addResolutionAndLocale(i,g,h),this.getUrl(i)},renderLegend:function(){}}),Spectrum4Leaflet.Layers.MapServiceLayer=L.Layer.extend({options:{opacity:1,alt:"",interactive:!1,imageType:"png",zIndex:"auto",updateInterval:200},initialize:function(a,b,c,d){this._mapName=b,this._service=a,this._postData=c,this.on("load",this._reset,this),L.setOptions(this,d)},onAdd:function(a){this._map=a,this._srs=a.options.crs,this._update=L.Util.throttle(this._update,this.options.updateInterval,this),this._update(),this._image||(this._initImage(),this.options.opacity<1&&this._updateOpacity()),a.on("moveend",this._update,this),this.getPane(this.options.pane).appendChild(this._image),this._initInteraction()},onRemove:function(){L.DomUtil.remove(this._image)},setOpacity:function(a){return this.options.opacity=a,this._image&&this._updateOpacity(),this},setStyle:function(a){return a.opacity&&this.setOpacity(a.opacity),this},setZIndex:function(a){this.options.zIndex=a,this._updateZIndex()},getZIndex:function(){return this.options.zIndex},bringToFront:function(){return this._map&&L.DomUtil.toFront(this._image),this},bringToBack:function(){return this._map&&L.DomUtil.toBack(this._image),this},getAttribution:function(){return this.options.attribution},getEvents:function(){var a={viewreset:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},getBounds:function(){return this._bounds},_initInteraction:function(){this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),L.DomEvent.on(this._image,"click dblclick mousedown mouseup mouseover mousemove mouseout contextmenu",this._fireMouseEvent,this))},_fireMouseEvent:function(a,b){this._map&&this._map._fireMouseEvent(this,a,b,!0)},_setUrl:function(a){return this._url=a,this._image&&(this._image.src=a),this},_initImage:function(){var a=this._image=L.DomUtil.create("img","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));a.onselectstart=L.Util.falseFn,a.onmousemove=L.Util.falseFn,a.style.zIndex=this.options.zIndex,a.onload=L.bind(this.fire,this,"load"),a.src=this._url,a.alt=this.options.alt},_animateZoom:function(a){var b=new L.Bounds(this._map._latLngToNewLayerPoint(this._bounds.getNorthWest(),a.zoom,a.center),this._map._latLngToNewLayerPoint(this._bounds.getSouthEast(),a.zoom,a.center)),c=b.min.add(b.getSize()._multiplyBy((1-1/a.scale)/2));L.DomUtil.setTransform(this._image,c,a.scale)},_reset:function(){var a=this._image,b=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),c=b.getSize();L.DomUtil.setPosition(a,b.min),a.style.width=c.x+"px",a.style.height=c.y+"px"},_update:function(){this._bounds=this._map.getBounds(),this._size=this._map.getSize();var a=this._srs.project(this._bounds.getNorthWest()),b=this._srs.project(this._bounds.getSouthEast());this._setUrl(this._service.getUrlRenderMapByBounds(this._mapName,this.options.imageType,this._size.x,this._size.y,[a.x,a.y,b.x,b.y],this._srs.code))},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity)},_updateZIndex:function(){this._image.style.zIndex=this.options.zIndex}});