/*! Spectrum4Leaflet 30-01-2015 */
var Spectrum4Leaflet={Version:"0.1",Services:{},Layers:{}};"undefined"!=typeof window&&window.L&&(window.L.spectrum4L=Spectrum4Leaflet),Spectrum4Leaflet.Util={},Spectrum4Leaflet.Request={_createRequest:function(a,b){var c=new XMLHttpRequest;return c.onerror=function(){a.call(b,{error:{code:500,message:"XMLHttpRequest error"}},null)},c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{var f=this.getResponseHeader("content-type");d="application/json"==f?JSON.parse(c.responseText):c.responseText}catch(g){d=null,e={code:500,message:"Could not parse response as JSON."}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c},get:function(a,b,c){var d=this._createRequest(b,c);return d.open("GET",a,!0),d.send(null),d},post:function(a,b,c,d){var e=this._createRequest(c,d);return e.open("POST",a,!0),e.setRequestHeader("Content-Type","application/json"),e.send(b),e}},Spectrum4Leaflet.Services.Operation=L.Class.extend({options:{name:"",getParams:{},postParams:{},forcePost:!1,paramsSeparator:";",queryStartCharacter:";"},initialize:function(a,b){b=b||{},b.name=a,L.Util.setOptions(this,b)},getUrlQuery:function(){var a=[],b=this.options.getParams;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];a.push(c+"="+d)}var e=this.options.name;return a.length>0&&(e+=this.options.queryStartCharacter+a.join(this.options.paramsSeparator)),e},getPostData:function(){return JSON.stringify(this.options.postParams)},isPostOperation:function(){return 0!==Object.keys(this.options.postParams).length|this.options.forcePost}}),Spectrum4Leaflet.Services.Service=L.Class.extend({options:{},initialize:function(a,b){b=b||{},b.url=a,L.Util.setOptions(this,b)},startRequest:function(a,b,c){var d=this.getUrl(a);return a.isPostOperation()?Spectrum4Leaflet.Request.post(d,a.getPostData(),b,c):Spectrum4Leaflet.Request.get(d,b,c)},getUrl:function(a){var b="/"===this.options.url.slice(-1)?"":"/";return this.options.url+b+a.getUrlQuery()}}),Spectrum4Leaflet.Services.MapService=Spectrum4Leaflet.Services.Service.extend({listNamedLayers:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("layers.json");a&&(d.options.getParams.l=a),this.startRequest(d,b,c)},describeNamedLayer:function(a,b,c,d){var e=new Spectrum4Leaflet.Services.Operation("layers/"+a);b&&(e.options.getParams.l=b),this.startRequest(e,c,d)},describeNamedLayers:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("layers.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");e.length<1e3?(d.options.getParams.q="describe",d.options.getParams.layers=e):d.options.postParams={Layers:a},this.startRequest(d,b,c)},listNamedMaps:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("maps.json");a&&(d.options.getParams.l=a),this.startRequest(d,b,c)},describeNamedMap:function(a,b,c,d){var e=new Spectrum4Leaflet.Services.Operation("maps/"+a);b&&(e.options.getParams.l=b),this.startRequest(e,c,d)},describeNamedMaps:function(a,b,c){var d=new Spectrum4Leaflet.Services.Operation("maps.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");e.length<1e3?(d.options.getParams.q="describe",d.options.getParams.layers=e):d.options.postParams={Maps:a},this.startRequest(d,b,c)},renderMap:function(a,b,c,d,e,f,g,h,i,j,k){var l=new Spectrum4Leaflet.Services.Operation("maps/"+a+"."+b);l.options.getParams.w=c,l.options.getParams.h=d,l.options.getParams.b=e.toBBoxString()+","+f,l.options.postParams=i,this.startRequest(opertaion,j,k)},getUrlRenderMap:function(a,b,c,d,e,f){var g=new Spectrum4Leaflet.Services.Operation("maps/"+a+"/image."+b);return g.options.getParams.w=c,g.options.getParams.h=d,g.options.getParams.b=e.join(",")+","+f,this.getUrl(g)}}),Spectrum4Leaflet.Layers.MapServiceLayer=L.Class.extend({includes:L.Mixin.Events,options:{pane:"overlayPane",opacity:1,alt:"",interactive:!1,imageType:"png"},initialize:function(a,b,c){this._serviceUrl=a,this._mapName=b,this._service=new Spectrum4Leaflet.Services.MapService(a),this.on("load",this._reset,this),L.setOptions(this,c)},onAdd:function(a){this._map=a,this._bounds=a.getBounds(),this._size=a.getSize(),this._srs=a.options.crs;var b=this._srs.project(this._bounds.getNorthWest()),c=this._srs.project(this._bounds.getSouthEast());this._url=this._service.getUrlRenderMap(this._mapName,this.options.imageType,this._size.x,this._size.y,[b.x,b.y,c.x,c.y],this._srs.code),this._image||(this._initImage(),this.options.opacity<1&&this._updateOpacity()),a.on("moveend",this._update,this),this._zoomAnimated=a._zoomAnimated,this.getAttribution&&this._map.attributionControl&&this._map.attributionControl.addAttribution(this.getAttribution()),this.getEvents&&a.on(this.getEvents(),this),this.getPane(this.options.pane).appendChild(this._image),this._initInteraction()},onRemove:function(){L.DomUtil.remove(this._image)},addTo:function(a){return a.addLayer(this),this},remove:function(){return this.removeFrom(this._map||this._mapToAdd)},removeFrom:function(a){return a&&a.removeLayer(this),this},setOpacity:function(a){return this.options.opacity=a,this._image&&this._updateOpacity(),this},setStyle:function(a){return a.opacity&&this.setOpacity(a.opacity),this},bringToFront:function(){return this._map&&L.DomUtil.toFront(this._image),this},bringToBack:function(){return this._map&&L.DomUtil.toBack(this._image),this},_initInteraction:function(){this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),L.DomEvent.on(this._image,"click dblclick mousedown mouseup mouseover mousemove mouseout contextmenu",this._fireMouseEvent,this))},_fireMouseEvent:function(a,b){this._map&&this._map._fireMouseEvent(this,a,b,!0)},setUrl:function(a){return this._url=a,this._image&&(this._image.src=a),this},getAttribution:function(){return this.options.attribution},getEvents:function(){var a={viewreset:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},getBounds:function(){return this._bounds},getPane:function(a){return this._map._panes[a]},_initImage:function(){var a=this._image=L.DomUtil.create("img","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));a.onselectstart=L.Util.falseFn,a.onmousemove=L.Util.falseFn,a.onload=L.bind(this.fire,this,"load"),a.src=this._url,a.alt=this.options.alt},_animateZoom:function(a){var b=new L.Bounds(this._map._latLngToNewLayerPoint(this._bounds.getNorthWest(),a.zoom,a.center),this._map._latLngToNewLayerPoint(this._bounds.getSouthEast(),a.zoom,a.center)),c=b.min.add(b.getSize()._multiplyBy((1-1/a.scale)/2));this.setTransform(this._image,c,a.scale)},setTransform:function(a,b,c){var d=b||new L.Point(0,0);a.style[L.DomUtil.TRANSFORM]="translate3d("+d.x+"px,"+d.y+"px,0)"+(c?" scale("+c+")":"")},_reset:function(){var a=this._image,b=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),c=b.getSize();L.DomUtil.setPosition(a,b.min),a.style.width=c.x+"px",a.style.height=c.y+"px"},_update:function(){this._bounds=this._map.getBounds();var a=this._srs.project(this._bounds.getNorthWest()),b=this._srs.project(this._bounds.getSouthEast());this._size=this._map.getSize(),this.setUrl(this._service.getUrlRenderMap(this._mapName,this.options.imageType,this._size.x,this._size.y,[a.x,a.y,b.x,b.y],this._srs.code))},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity)}});