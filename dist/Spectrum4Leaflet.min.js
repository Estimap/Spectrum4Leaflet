/*! Spectrum4Leaflet 24-02-2015 */
L.SpectrumSpatial={Version:"0.1.0",Services:{},Layers:{},Controls:{},Defaults:{proxyUrl:void 0,alwaysUseProxy:!1,forceGet:!0,encodeUrlForProxy:!1},Projection:{},Support:{CORS:"withCredentials"in new XMLHttpRequest}},"undefined"!=typeof window&&window.L&&(window.L.SpectrumSpatial=L.SpectrumSpatial),L.SpectrumSpatial.Utils={sortByProperty:function(a,b){var c="desc"===b?-1:1;return function(b,d){var e=b[a]<d[a]?-1:b[a]>d[a]?1:0;return e*c}},sortByFuncResult:function(a,b){var c="desc"===b?-1:1;return function(b,d){var e=b[a]()<d[a]()?-1:b[a]()>d[a]()?1:0;return e*c}},getElementsByName:function(a,b){var c=[];if(!a.childNodes)return c;for(var d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];e.childNodes&&e.childNodes.length>0&&(c=c.concat(L.SpectrumSpatial.Utils.getElementsByName(e,b))),e.name&&e.name===b&&c.push(e)}return c},merge:function(a,b){if(b)for(var c in b)a[c]=b[c];return a},countPixelDistance:function(a,b,c){c||(c=a.getCenter());var d=a.latLngToContainerPoint(c),e=[d.x+b,d.y],f=[d.x,d.y+b],g=a.containerPointToLatLng(d),h=a.containerPointToLatLng(e),i=a.containerPointToLatLng(f),j=g.distanceTo(h),k=g.distanceTo(i);return Math.max(j,k)}},this.proj4||(this.proj4=function(){console.log("Please add reference to proj4js")}),L.SpectrumSpatial.Projection.SimpleMercator={R:6378137,epsg4326:proj4("EPSG:4326"),epsg41001:proj4('PROJCS["WGS84 / Simple Mercator",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS_1984", 6378137.0, 298.257223563]],PRIMEM["Greenwich", 0.0], UNIT["degree", 0.017453292519943295], AXIS["Longitude", EAST],  AXIS["Latitude", NORTH]], PROJECTION["Mercator_1SP"], PARAMETER["latitude_of_origin", 0.0],PARAMETER["central_meridian", 0.0],PARAMETER["scale_factor", 1.0],PARAMETER["false_easting", 0.0],PARAMETER["false_northing", 0.0], UNIT["m", 1.0],AXIS["x", EAST],AXIS["y", NORTH],AUTHORITY["EPSG","41001"]]'),project:function(a){var b=proj4(L.SpectrumSpatial.Projection.SimpleMercator.epsg41001,[a.lng,a.lat]);return new L.Point(b[0],b[1])},unproject:function(a){var b=proj4(L.SpectrumSpatial.Projection.SimpleMercator.epsg41001,L.SpectrumSpatial.Projection.SimpleMercator.epsg4326,a);return new L.LatLng(b.y,b.x)},bounds:function(){var a=6378137*Math.PI;return L.bounds([-a,-a],[a,a])}()},L.CRS.EPSG41001=L.extend({},L.CRS.Earth,{code:"EPSG:41001",projection:L.SpectrumSpatial.Projection.SimpleMercator,transformation:function(){var a=.5/(Math.PI*L.SpectrumSpatial.Projection.SimpleMercator.R);return new L.Transformation(a,.5,-a,.5)}()}),function(){var a=0;window._Spectrum4LeafletCallbacks={},L.SpectrumSpatial.Request={_createRequest:function(a,b){var c=new XMLHttpRequest;return c.onerror=function(){a.call(b,{error:{code:500,message:"XMLHttpRequest error"}},null)},c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{var f=this.getResponseHeader("content-type");d=-1!==f.indexOf("application/json")?JSON.parse(c.responseText):c.response}catch(g){d=null,e={code:500,message:"Could not parse response as JSON."}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c},get:function(a,b,c,d){d=d||{};var e=this._createRequest(b,c);return e.open("GET",a,!0,d.login,d.password),d.responseType&&(e.responseType=d.responseType),e.send(null),e},jsonp:function(b,c,d,e){var f="c"+a;e||(e="");var g=L.DomUtil.create("script",null,document.body);return g.type="text/javascript",g.src=b+e+"callback=window._Spectrum4LeafletCallbacks."+f,g.id=f,window._Spectrum4LeafletCallbacks[f]=function(a){if(window._Spectrum4LeafletCallbacks[f]!==!0){var b,e=Object.prototype.toString.call(a);"[object Object]"!==e&&"[object Array]"!==e&&(b={error:{code:500,message:"Expected array or object as JSONP response"}},a=null),!b&&a.error&&(b=a,a=null),c.call(d,b,a),window._Spectrum4LeafletCallbacks[f]=!0}},a++,{id:f,url:g.src,abort:function(){window._Spectrum4LeafletCallbacks._callback[f]({code:0,message:"Request aborted."})}}},post:function(a,b,c,d){d=d||{},d.postType||(d.postType="application/json");var e=this._createRequest(b,c);return e.open("POST",a,!0,d.login,d.password),e.setRequestHeader("Content-Type",d.postType),d.responseType&&(e.responseType=d.responseType),e.send(d.postData),e}}}(),L.SpectrumSpatial.Services.Operation=L.Class.extend({options:{forcePost:!1,paramsSeparator:";",queryStartCharacter:";",postType:"application/json",responseType:null},initialize:function(a,b){this.options.getParams={},this.options.postParams={},b=b||{},b.name=a,L.setOptions(this,b)},getUrlQuery:function(){var a=[],b=this.options.getParams;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];a.push(c+"="+encodeURIComponent(d))}var e=this.options.name;return a.length>0&&(e+=this.options.queryStartCharacter+a.join(this.options.paramsSeparator)),e},getPostData:function(){return JSON.stringify(this.options.postParams)},getPostType:function(){return this.options.postType},getResponseType:function(){return this.options.responseType},isPostOperation:function(){return 0!==Object.keys(this.options.postParams).length|this.options.forcePost}}),L.SpectrumSpatial.Services.operation=function(a,b){return new L.SpectrumSpatial.Services.Operation(a,b)},L.SpectrumSpatial.Services.Service=L.Class.extend({options:{},initialize:function(a,b){b=L.SpectrumSpatial.Utils.merge({alwaysUseProxy:L.SpectrumSpatial.Defaults.alwaysUseProxy,forceGet:L.SpectrumSpatial.Defaults.forceGet,encodeUrlForProxy:L.SpectrumSpatial.Defaults.encodeUrlForProxy,url:a},b),void 0===b.proxyUrl&void 0!==L.SpectrumSpatial.Defaults.proxyUrl&&(b.proxyUrl=L.SpectrumSpatial.Defaults.proxyUrl),L.Util.setOptions(this,b)},startRequest:function(a,b,c){var d=this.getUrl(a),e={postData:a.getPostData(),postType:a.getPostType(),responseType:a.getResponseType(),login:this.options.login,password:this.options.password};return a.isPostOperation()?(this.options.proxyUrl&&(d=this.options.proxyUrl+this.checkEncodeUrl(d)),L.SpectrumSpatial.Request.post(d,b,c,e)):this.options.alwaysUseProxy|void 0!==this.options.proxyUrl?(d=this.options.proxyUrl+this.checkEncodeUrl(d),L.SpectrumSpatial.Request.get(d,b,c,e)):this.options.forceGet|L.SpectrumSpatial.Support.CORS?L.SpectrumSpatial.Request.get(d,b,c,e):L.SpectrumSpatial.Request.jsonp(d,b,c,"?")},getUrl:function(a){var b=this.clearParam(a.getUrlQuery()),c="/"===this.options.url.slice(-1)?"":"/";return this.options.url+c+b},clearParam:function(a){return"/"===a[0]&&(a=a.substring(1)),"/"===a.slice(-1)&&(a=a.substring(0,a.length-1)),a},checkEncodeUrl:function(a){return this.options.encodeUrlForProxy?encodeURIComponent(a):a},needAuthorization:function(){return void 0!==this.options.login}}),L.SpectrumSpatial.Services.service=function(a,b){return new L.SpectrumSpatial.Services.Service(a,b)},L.SpectrumSpatial.Services.MapService=L.SpectrumSpatial.Services.Service.extend({listNamedLayers:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("layers.json");this._addResolutionAndLocale(d,null,c),this.startRequest(d,a,b)},describeNamedLayer:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("layers/"+this.clearParam(a)+".json");this._addResolutionAndLocale(e,null,d),this.startRequest(e,b,c)},describeNamedLayers:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("layers.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");d.options.getParams.q="describe",e.length<1e3?d.options.getParams.layers=e:d.options.postParams={Layers:a},this.startRequest(d,b,c)},listNamedMaps:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("maps.json");this._addResolutionAndLocale(d,null,c),this.startRequest(d,a,b)},describeNamedMap:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a)+".json");this._addResolutionAndLocale(e,null,d),this.startRequest(e,b,c)},describeNamedMaps:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("maps.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");e.length<1e3?(d.options.getParams.q="describe",d.options.getParams.maps=e):d.options.postParams={Maps:a},this.startRequest(d,b,c)},_createRenderOperation:function(a){var b=this.clearParam(a.mapName);""!==b&&(b="/"+b),a.imageType||(a.imageType="png");var c=new L.SpectrumSpatial.Services.Operation("maps"+b+"/image."+a.imageType,{responseType:"arraybuffer"});return c.options.getParams.w=a.width,c.options.getParams.h=a.height,a.bounds?c.options.getParams.b=a.bounds.join(",")+","+a.srs:c.options.getParams.c=a.cx+","+a.cy+","+a.srs,a.scale&&(c.options.getParams.s=a.scale),a.zoom&&(c.options.getParams.z=a.zoom),this._addResolutionAndLocale(c,a.resolution,a.locale),a.rd&&(c.options.getParams.rd=a.rd),a.bc&&(c.options.getParams.bc=a.bc),a.bo&&(c.options.getParams.bc=a.bc),a.additionalParams&&(c.options.postParams=a.additionalParams),c},_addResolutionAndLocale:function(a,b,c){b&&(a.options.getParams.r=b),c&&(a.options.getParams.l=c)},renderMap:function(a,b,c){var d=this._createRenderOperation(a);this.startRequest(d,b,c)},getUrlRenderMap:function(a){var b=this._createRenderOperation(a);return(this.options.alwaysUseProxy?this.options.proxyUrl:"")+this.checkEncodeUrl(this.getUrl(b))},getLegendForMap:function(a,b,c){a.imageType||(a.imageType="png");var d=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a.mapName)+"/legends.json");d.options.getParams.w=a.width,d.options.getParams.h=a.height,d.options.getParams.t=a.imageType,this._addResolutionAndLocale(d,a.resolution,a.locale),void 0!==a.inlineSwatch&&(d.options.getParams["?inlineSwatch"]=a.inlineSwatch),a.postData&&(d.options.postParams=a.postData,d.options.responseType="arraybuffer"),this.startRequest(d,b,c)},_createSwatchOperation:function(a){a.imageType||(a.imageType="png");var b=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a.mapName)+"/legends/"+a.legendIndex+"/rows/"+a.rowIndex+"/swatch/"+a.width+"x"+a.height+"."+a.imageType);return this._addResolutionAndLocale(b,a.resolution,a.locale),b},getSwatchForLayer:function(a,b,c){this.startRequest(this._createSwatchOperation(a),b,c)},getUrlSwatchForLayer:function(a){return this.getUrl(this._createSwatchOperation(a))}}),L.SpectrumSpatial.Services.mapService=function(a,b){return new L.SpectrumSpatial.Services.MapService(a,b)},L.SpectrumSpatial.Services.TileService=L.SpectrumSpatial.Services.Service.extend({mapList:function(a,b){var c=new L.SpectrumSpatial.Services.Operation("mapList.json");this.startRequest(c,a,b)},description:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("/"+this.clearParam(a)+"/description.json");this.startRequest(d,b,c)},getTileUrl:function(a,b,c,d,e){e||(e="png");var f=this._createTileOperation(a,b,c,d,e);return(this.options.alwaysUseProxy?this.options.proxyUrl:"")+this.checkEncodeUrl(this.getUrl(f))},getTile:function(a,b,c,d,e,f,g){g||(g="png");var h=this._createTileOperation(a,b,c,d,g);this.startRequest(h,e,f)},_createTileOperation:function(a,b,c,d,e){return a=this.clearParam(a),""!==a&&(a="/"+a),new L.SpectrumSpatial.Services.Operation(a+"/"+b+"/"+c+":"+d+"/tile."+e,{responseType:"arraybuffer"})}}),L.SpectrumSpatial.Services.tileService=function(a,b){return new L.SpectrumSpatial.Services.TileService(a,b)},L.SpectrumSpatial.Services.FeatureService=L.SpectrumSpatial.Services.Service.extend({tableList:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("tables.json");c&&(d.options.getParams.l=c),this.startRequest(d,a,b)},count:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("tables/count");c&&(d.options.getParams.l=c),this.startRequest(d,a,b)},featureCount:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/features/count",{paramsSeparator:"&",queryStartCharacter:"?"});L.SpectrumSpatial.Utils.merge(e.options.getParams,d),this.startRequest(e,b,c)},describe:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/metadata.json");d&&(e.options.getParams.l=d),this.startRequest(e,b,c)},insert:function(a,b,c,d,e){var f=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/features.json",{paramsSeparator:"&",queryStartCharacter:"?"});f.options.getParams.action="insert",e&&(f.options.getParams.commitInterval=e),f.options.postParams=b,this.startRequest(f,c,d)},searchAtPoint:function(a,b,c,d,e,f){var g=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/features.json",{paramsSeparator:"&",queryStartCharacter:"?"});g.options.getParams.q="searchAtPoint",g.options.getParams.point=b.x+","+b.y+","+c,L.SpectrumSpatial.Utils.merge(g.options.getParams,f),this.startRequest(g,d,e)},searchNearest:function(a,b,c,d,e){var f=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/features.json",{paramsSeparator:"&",queryStartCharacter:"?"});f.options.getParams.q="searchNearest",f.options.getParams.geometry=JSON.stringify(b),L.SpectrumSpatial.Utils.merge(f.options.getParams,e),this.startRequest(f,c,d)},searchId:function(a,b,c,d,e,f){var g=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/features.json"+(e?";attributes="+e:"")+(f?";l="+f:"")+"/"+b);this.startRequest(g,c,d)},searchSQL:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("tables/features.json",{paramsSeparator:"&",queryStartCharacter:"?"});e.options.getParams.q=a,L.SpectrumSpatial.Utils.merge(e.options.getParams,d),this.startRequest(e,b,c)},update:function(a,b,c,d,e){var f=new L.SpectrumSpatial.Services.Operation("tables/"+this.clearParam(a)+"/features.json",{paramsSeparator:"&",queryStartCharacter:"?"});f.options.getParams.action="update",e&&(f.options.getParams.commitInterval=e),f.options.postParams=b,this.startRequest(f,c,d)},updateSQL:function(a,b,c,d,e){var f=new L.SpectrumSpatial.Services.Operation("tables/features.json",{paramsSeparator:"&",queryStartCharacter:"?"});f.options.getParams.update=a,e&&(f.options.getParams.l=e),d&&(f.options.postParams=d),this.startRequest(f,b,c)}}),L.SpectrumSpatial.Services.featureService=function(a,b){return new L.SpectrumSpatial.Services.FeatureService(a,b)},L.SpectrumSpatial.Layers.MapServiceLayer=L.Layer.extend({options:{opacity:1,alt:"",interactive:!1,imageType:"png",zIndex:"auto",updateInterval:200},initialize:function(a,b,c,d){this._mapName=b,this._service=a,this._postData=c,L.setOptions(this,d)},onAdd:function(a){if(this._map=a,this._srs=a.options.crs,this._update=L.Util.throttle(this._update,this.options.updateInterval,this),a.on("moveend",this._update,this),"auto"===this.options.zIndex){var b=0;for(var c in a._layers){var d=a._layers[c];if(d.getZIndex){var e=d.getZIndex();e>b&&(b=e)}}this.options.zIndex=b+1}this._update()},onRemove:function(){L.DomUtil.remove(this._image),delete this._image},setService:function(a){return this._service=a,this._update(),this},setMapName:function(a){return this._mapName=a,this._update(),this},setPostData:function(a){return this._postData=a,this._update(),this},setOpacity:function(a){return this.options.opacity=a,this._image&&this._updateOpacity(),this},getOpacity:function(){return this.options.opacity},setStyle:function(a){return a.opacity&&this.setOpacity(a.opacity),this},setZIndex:function(a){return this.options.zIndex=a,this._updateZIndex(),this},getZIndex:function(){return this.options.zIndex},bringToFront:function(){return this._map&&L.DomUtil.toFront(this._image),this},bringToBack:function(){return this._map&&L.DomUtil.toBack(this._image),this},getAttribution:function(){return this.options.attribution},getEvents:function(){var a={viewreset:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},getBounds:function(){return this._bounds},_initInteraction:function(){this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),L.DomEvent.on(this._image,"click dblclick mousedown mouseup mouseover mousemove mouseout contextmenu",this._fireMouseEvent,this))},_fireMouseEvent:function(a,b){this._map&&this._map._fireMouseEvent(this,a,b,!0)},_initImage:function(){var a=L.DomUtil.create("img","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));return a.onselectstart=L.Util.falseFn,a.onmousemove=L.Util.falseFn,a.style.zIndex=this.options.zIndex,a.alt=this.options.alt,this.options.opacity<1&&L.DomUtil.setOpacity(a,this.options.opacity),a},_requestCounter:0,_animateZoom:function(a){var b=new L.Bounds(this._map._latLngToNewLayerPoint(this._bounds.getNorthWest(),a.zoom,a.center),this._map._latLngToNewLayerPoint(this._bounds.getSouthEast(),a.zoom,a.center)),c=b.min.add(b.getSize()._multiplyBy((1-1/a.scale)/2));L.DomUtil.setTransform(this._image,c,a.scale)},_reset:function(){var a=this._image,b=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),c=b.getSize();L.DomUtil.setPosition(a,b.min),a.style.width=c.x+"px",a.style.height=c.y+"px"},_update:function(){if(!(this._map._animatingZoom||this._map._panAnim&&this._map._panAnim._inProgress)){var a=this._map.getBounds(),b=this._map.getSize(),c=this._srs.project(a.getNorthWest()),d=this._srs.project(a.getSouthEast()),e=this._initImage();this._requestCounter++;var f={mapName:this._mapName,imageType:this.options.imageType,width:b.x,height:b.y,bounds:[c.x,c.y,d.x,d.y],srs:this._srs.code,additionalParams:this._postData};void 0!==this._postData|this._service.needAuthorization()?this._service.renderMap(f,this._postLoad,{context:this,image:e,bounds:a,counter:this._requestCounter}):(e.onload=L.bind(this._afterLoad,this,{image:e,bounds:a,counter:this._requestCounter}),e.src=this._service.getUrlRenderMap(f)),this.fire("loading")}},_afterLoad:function(a){if(this._requestCounter!=a.counter)return void delete a.image;this.fire("load"),this._bounds=a.bounds,this._size=this._map.getSize();var b=a.image,c=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),d=c.getSize();L.DomUtil.setPosition(b,c.min),b.style.width=d.x+"px",b.style.height=d.y+"px",this.getPane(this.options.pane).appendChild(b),this._image&&(this.getPane(this.options.pane).removeChild(this._image),L.DomEvent.off(this._image,"click dblclick mousedown mouseup mouseover mousemove mouseout contextmenu",this._fireMouseEvent,this),delete this._image),this._image=b,this._initInteraction()},_postLoad:function(a,b){for(var c=new Uint8Array(b),d=c.length,e=new Array(d);d--;)e[d]=String.fromCharCode(c[d]);var f=e.join(""),g=window.btoa(f);this.image.src="data:image/png;base64,"+g,this.context._afterLoad({image:this.image,bounds:this.bounds,counter:this.counter})},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity)},_updateZIndex:function(){this._image&&(this._image.style.zIndex=this.options.zIndex)}}),L.SpectrumSpatial.Layers.mapServiceLayer=function(a,b,c,d){return new L.SpectrumSpatial.Layers.MapServiceLayer(a,b,c,d)},L.SpectrumSpatial.Layers.TileServiceLayer=L.GridLayer.extend({options:{maxZoom:18,minZoom:0,errorTileUrl:"",zoomOffset:0,maxNativeZoom:null,tms:!1,zoomReverse:!1,detectRetina:!1,crossOrigin:!1,imageType:"png"},initialize:function(a,b,c){this._service=a,this._mapName=b,c=L.setOptions(this,c),c.detectRetina&&L.Browser.retina&&c.maxZoom>0&&(c.tileSize=Math.floor(c.tileSize/2),c.zoomOffset++,c.minZoom=Math.max(0,c.minZoom),c.maxZoom--),L.Browser.android||this.on("tileunload",this._onTileRemove)},setService:function(a,b){return this._service=a,b||this.redraw(),this},setMapName:function(a,b){return this._mapName=a,b||this.redraw(),this},createTile:function(a,b){var c=document.createElement("img");return this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c.onerror=L.bind(this._tileOnError,this,b,c),this._service.needAuthorization()?this._service.getTile(this._mapName,this._getZoomForUrl()+1,a.x+1,(this.options.tms?this._globalTileRange.max.y-a.y:a.y)+1,this._postLoad,{context:this,image:c,done:b},this.options.imageType):(c.onload=L.bind(this._tileOnLoad,this,b,c),c.src=this.getTileUrl(a)),c},_postLoad:function(a,b){for(var c=new Uint8Array(b),d=c.length,e=new Array(d);d--;)e[d]=String.fromCharCode(c[d]);var f=e.join(""),g=window.btoa(f);this.image.src="data:image/png;base64,"+g,this.context._tileOnLoad.call(this.context,this.done,this.image)},getTileUrl:function(a){return this._service.getTileUrl(this._mapName,this._getZoomForUrl()+1,a.x+1,(this.options.tms?this._globalTileRange.max.y-a.y:a.y)+1,this.options.imageType)},_tileOnLoad:function(a,b){a(null,b)},_tileOnError:function(a,b,c){var d=this.options.errorTileUrl;d&&(b.src=d),a(c,b)},_getTileSize:function(){var a=this._map,b=this.options,c=a.getZoom()+b.zoomOffset,d=b.maxNativeZoom;return null!==d&&c>d?Math.round(a.getZoomScale(d,c)*b.tileSize):b.tileSize},_onTileRemove:function(a){a.tile.onload=null},_getZoomForUrl:function(){var a=this.options,b=this._tileZoom;return a.zoomReverse&&(b=a.maxZoom-b),b+=a.zoomOffset,a.maxNativeZoom?Math.min(b,a.maxNativeZoom):b},_abortLoading:function(){var a,b;for(a in this._tiles)b=this._tiles[a].el,b.onload=L.Util.falseFn,b.onerror=L.Util.falseFn,b.complete||(b.src=L.Util.emptyImageUrl,L.DomUtil.remove(b))}}),L.SpectrumSpatial.Layers.tileServiceLayer=function(a,b,c){return new L.SpectrumSpatial.Layers.TileServiceLayer(a,b,c)},L.SpectrumSpatial.Controls.Layers=L.Control.Layers.extend({className:"leaflet-ss-control-layers",options:{zIndexControls:!0,opacityControls:!0,legendControls:!0,legendOptions:{},legendContainer:null,inverseOrder:!1},initialize:function(a,b,c){L.setOptions(this,c),this._layers={},this.options.legendOptions||(this.options.legendOptions={}),void 0===this.options.legendOptions.cssOff&&(this.options.legendOptions.cssOff=!0),this._minZIndex=1,this._maxZIndex=0,this._handlingClick=!1;for(var d in a)this._addLayer(a[d],d);for(d in b)this._addLayer(b[d],d,!0)},addTo:function(a,b){this.remove(),this._map=a;var c=this._container=this.onAdd(a);if(b)b.appendChild(c);else{L.DomUtil.addClass(c,"leaflet-control");var d=this.getPosition(),e=a._controlCorners[d];-1!==d.indexOf("bottom")?e.insertBefore(c,e.firstChild):e.appendChild(c)}return this},_addLayer:function(a,b,c){if(a.on("add remove",this._onLayerChange,this),c&&this.options.autoZIndex&&a.setZIndex&&(this._maxZIndex++,a.setZIndex(this._maxZIndex)),c&&!this.options.autoZIndex&&a.getZIndex){var d=a.getZIndex();this._minZIndex>d&&(this._minZIndex=d),this._maxZIndex<d&&(this._maxZIndex=d)}var e=L.stamp(a);this._layers[e]={layer:a,name:b,overlay:c}},_update:function(){if(!this._container)return this;L.DomUtil.empty(this._baseLayersList),L.DomUtil.empty(this._overlaysList);var a,b,c,d,e=0,f=[];for(c in this._layers)d=this._layers[c],b=b||d.overlay,a=a||!d.overlay,e+=d.overlay?0:1,d.overlay?f.push({lo:d,z:d.layer.getZIndex()}):this._addItem(d);f.sort(L.SpectrumSpatial.Utils.sortByProperty("z",this.options.inverseOrder?"desc":"asc"));for(c in f)d=f[c],this._addItem(d.lo);return this.options.hideSingleBase&&(a=a&&e>1,this._baseLayersList.style.display=a?"":"none"),this._separator.style.display=b&&a?"":"none",this},_initLayout:function(){var a=this._container=L.DomUtil.create("div",this.options.cssOff?"":this.className);a.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(a).disableScrollPropagation(a);var b=this._form=L.DomUtil.create("form",this.className+"-list");if(this.options.collapsed){L.Browser.android||L.DomEvent.on(a,{mouseenter:this._expand,mouseleave:this._collapse},this);var c=this._layersLink=L.DomUtil.create("a","leaflet-control-layers-toggle",a);c.href="#",c.title="Layers",L.Browser.touch?L.DomEvent.on(c,"click",L.DomEvent.stop).on(c,"click",this._expand,this):L.DomEvent.on(c,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();this._baseLayersList=L.DomUtil.create("div",this.className+"-base",b),this._separator=L.DomUtil.create("div",this.className+"-separator",b),this._overlaysList=L.DomUtil.create("div",this.className+"-overlay",b),a.appendChild(b)},_createRadioElement:function(a,b){var c='<input type="radio" class="leaflet-ss-cell leaflet-ss-control-layers-selector" name="'+a+'"'+(b?' checked="checked"':"")+"/>",d=document.createElement("div");return d.innerHTML=c,d.firstChild},_addItem:function(a){var b,c=L.DomUtil.create("div","leaflet-ss-rowcontainer"),d=L.DomUtil.create("div","leaflet-ss-row",c),e=this._map.hasLayer(a.layer);a.overlay?(b=L.DomUtil.create("input","leaflet-ss-cell leaflet-control-layers-selector"),b.name="visibilityInput",b.type="checkbox",b.defaultChecked=e):b=this._createRadioElement("visibilityInput",e),b.layerId=L.stamp(a.layer),L.DomEvent.on(b,"click",this._onVisibilityChanged,this);var f=L.DomUtil.create("span","leaflet-ss-cell leaflet-ss-control-layers-title");if(f.innerHTML=" "+a.name,d.appendChild(b),a.overlay){if(this.options.zIndexControls&&(d.appendChild(this._createZIndexButton("up",a.layer,b.layerId)),d.appendChild(this._createZIndexButton("down",a.layer,b.layerId))),this.options.legendControls){var g=L.DomUtil.create("div","leaflet-ss-cell leaflet-ss-control-layers-btn leaflet-ss-control-layers-legend");g.layerId=b.layerId,L.DomEvent.on(g,"click",this._onLegendClick,this),d.appendChild(g),this.options.legendContainer?a.legendContainer=this.options.legendContainer:(a.legendContainer=document.createElement("div","leaflet-ss-row"),c.appendChild(a.legendContainer))}if(this.options.opacityControls){var h=L.DomUtil.create("input","leaflet-ss-cell leaflet-ss-control-layers-input");h.type="text",h.name="opacityInput",h.value=a.layer.getOpacity?a.layer.getOpacity():this.options.opacity,h.layerId=L.stamp(a.layer),L.DomEvent.on(h,"input",this._onOpacityChanged,this),d.appendChild(h)}}d.appendChild(f);var i=a.overlay?this._overlaysList:this._baseLayersList;return i.appendChild(c),a.container=c,c},_createZIndexButton:function(a,b,c){var d="leaflet-ss-cell leaflet-ss-control-layers-btn leaflet-ss-control-layers-"+a,e="up"===a&this.options.inverseOrder|"down"===a&!this.options.inverseOrder?"up":"down",f="up"===e?this._onUpClick:this._onDownClick,g="up"===e?this._maxZIndex:this._minZIndex,h=L.DomUtil.create("div",d);return h.layerId=c,L.DomEvent.on(h,"click",f,this),b.getZIndex()===g&&L.DomUtil.addClass(h,"leaflet-ss-disabled"),h},_onLegendClick:function(a){var b,c=a.currentTarget.layerId,d=this._layers[c];this.options.legendContainer?(b=new L.SpectrumSpatial.Controls.Legend(d.layer._service,d.layer._mapName,this.options.legendOptions),b.addTo(this._map,this.options.legendContainer?this.options.legendContainer:d.legendContainer)):d.legendContainer.hasChildNodes()?L.DomUtil.empty(d.legendContainer):(b=new L.SpectrumSpatial.Controls.Legend(d.layer._service,d.layer._mapName,this.options.legendOptions),b.addTo(this._map,this.options.legendContainer?this.options.legendContainer:d.legendContainer))},_onDownClick:function(a){var b=a.currentTarget.layerId,c=this._layers[b].layer,d=c.getZIndex(),e=this._findOverlayByZ(d-1);e&&(e.layer.setZIndex(d),c.setZIndex(d-1),this._update())},_onUpClick:function(a){var b=a.currentTarget.layerId,c=this._layers[b].layer,d=c.getZIndex(),e=this._findOverlayByZ(d+1);e&&(e.layer.setZIndex(d),c.setZIndex(d+1),this._update())},_findOverlayByZ:function(a){for(var b in this._layers)if(obj=this._layers[b],obj.overlay&&obj.layer.getZIndex()===a)return obj;return null},_onVisibilityChanged:function(){var a,b,c,d=L.SpectrumSpatial.Utils.getElementsByName(this._container,"visibilityInput"),e=[],f=[];this._handlingClick=!0;for(var g=0,h=d.length;h>g;g++)a=d[g],b=this._layers[a.layerId].layer,c=this._map.hasLayer(b),a.checked&&!c?e.push(b):!a.checked&&c&&f.push(b);for(g=0;g<f.length;g++)this._map.removeLayer(f[g]);for(g=0;g<e.length;g++)this._map.addLayer(e[g]);this._handlingClick=!1,this._refocusOnMap()},_onOpacityChanged:function(){var a,b,c=L.SpectrumSpatial.Utils.getElementsByName(this._container,"opacityInput");this._handlingClick=!0;for(var d=0,e=c.length;e>d;d++){a=c[d],b=this._layers[a.layerId].layer;var f=parseFloat(a.value);b.setOpacity&&!isNaN(f)&&b.setOpacity(f)}this._handlingClick=!1},_expand:function(){L.DomUtil.addClass(this._container,this.className+"-expanded")},_collapse:function(){L.DomUtil.removeClass(this._container,this.className+"-expanded")}}),L.SpectrumSpatial.Controls.layers=function(a,b,c){return new L.SpectrumSpatial.Controls.Layers(a,b,c)},L.SpectrumSpatial.Controls.Legend=L.Control.extend({className:"leaflet-ss-control-legend",options:{position:"bottomright",width:16,height:16,imageType:"png",hasCartographic:!0},initialize:function(a,b,c){L.setOptions(this,c),this._service=a,this.options.mapName=b},addTo:function(a,b){this.remove(),this._map=a;var c=this._container=this.onAdd(a);if(b)L.DomUtil.empty(b),b.appendChild(c);else{L.DomUtil.addClass(c,"leaflet-control");var d=this.getPosition(),e=a._controlCorners[d];-1!==d.indexOf("bottom")?e.insertBefore(c,e.firstChild):e.appendChild(c)}return this},onAdd:function(){return this._initLayout(),this._requestLegend(),this._container},_requestLegend:function(){this._service.getLegendForMap(this.options,this._legendCallback,this),L.DomUtil.empty(this._legendList);var a=L.DomUtil.create("div","leaflet-ss-wait");this._legendList.appendChild(a)},_legendCallback:function(a,b){a||(this._legend=b.LegendResponse,this._update())},_update:function(){if(!this._container)return this;if(!this._legend)return this;L.DomUtil.empty(this._legendList);for(var a in this._legend)if(obj=this._legend[a],this.options.hasCartographic||"CARTOGRAPHIC"!==obj.type){var b=L.DomUtil.create("div","leaflet-ss-control-legend-layer"),c=L.DomUtil.create("div","leaflet-ss-row leaflet-ss-control-legend-title");c.innerHTML=obj.title,b.appendChild(c);for(var d in obj.rows){row=obj.rows[d];var e=L.DomUtil.create("div","leaflet-ss-row"),f=L.DomUtil.create("div","leaflet-ss-cell"),g=L.DomUtil.create("img","",f);g.src=row.swatch;var h=L.DomUtil.create("div","leaflet-ss-cell");h.innerHTML=row.description,e.appendChild(f),e.appendChild(h),b.appendChild(e)}this._legendList.appendChild(b)}return this},_initLayout:function(){var a=this._container=L.DomUtil.create("div",this.options.cssOff?"":this.className);this._legendList=L.DomUtil.create("div",this.className+"-list",a)}}),L.SpectrumSpatial.Controls.legend=function(a,b,c){return new L.SpectrumSpatial.Controls.Legend(a,b,c)},L.SpectrumSpatial.Controls.Feature=L.Control.extend({className:"leaflet-ss-control-feature",options:{pixelTolerance:0,hideTypes:["Geometry","Style"],showIfEmpty:!1,useDefaultProjection:!0},initialize:function(a,b,c){L.setOptions(this,c),this._service=a,this._featureLayers=b},addTo:function(a){this.remove(),this._map=a;var b=this._container=this.onAdd(a);L.DomUtil.addClass(b,"leaflet-control");var c=this.getPosition(),d=a._controlCorners[c];return-1!==c.indexOf("bottom")?d.insertBefore(b,d.firstChild):d.appendChild(b),this},onAdd:function(){var a=this._container=L.DomUtil.create("div",this.options.cssOff?"":this.className);return this._featureInfo=L.DomUtil.create("div","leaflet-ss-control-feature-info"),L.DomEvent.on(this._featureInfo,"click",this._onFeatureInfoClick,this),a.appendChild(this._featureInfo),this._container},_onFeatureInfoClick:function(a){this.setActive(!this._active),L.DomEvent.stopPropagation(a)},_getFeatureInfo:function(a){this._waitImage||(this._waitImage=L.DomUtil.create("div","leaflet-ss-wait")),this._featureInfo.style.display="none",this._container.appendChild(this._waitImage);var b={position:a.latlng,all:this._featureLayers.length,requested:[],hasFeatures:!1},c=a.layerPoint,d=map.options.crs.code;this.options.useDefaultProjection&&(d="EPSG:4326",c={x:a.latlng.lng,y:a.latlng.lat});var e;0!==this.options.pixelTolerance&&(e=Math.round(L.SpectrumSpatial.Utils.countPixelDistance(this._map,this.options.pixelTolerance,a.latlng)));for(var f in this._featureLayers){var g=this._featureLayers[f],h=L.SpectrumSpatial.Utils.merge({},g.options);void 0===g.options.tolerance&void 0!==e&&(h.tolerance=e+" m"),this._service.searchAtPoint(g.tableName,c,d,this._serviceCallback,{context:this,collector:b,layerSettings:g},h)}},_serviceCallback:function(a,b){var c=this.collector;b.features&&b.features.length>0&&(c.hasFeatures=!0),c.requested.push({layerSettings:this.layerSettings,data:b}),c.all===c.requested.length&&this.context._queryEnded.call(this.context,c)
},_queryEnded:function(a){this._featureInfo.style.display="block",this._container.removeChild(this._waitImage),this._clearPopup(),this.options.showIfEmpty|a.hasFeatures&&(this._popup=L.popup().setLatLng(a.position).setContent(this.getPopupHtmlContent(a.requested)).openOn(this._map))},getPopupHtmlContent:function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];if(d.data.features&&d.data.features.length>0){b+=L.Util.template("<b>{title}</b><br/>",d.layerSettings),b+="<table><thead><tr>";var e=[];for(var f in d.data.Metadata){var g=d.data.Metadata[f];-1===this.options.hideTypes.indexOf(g.type)&&(e.push(g.name),b+=L.Util.template("<th>{name}</th>",g))}b+="</tr></thead><tbody>";for(var h in d.data.features){var i=d.data.features[h];b+="<tr>";for(var j in e){var k=e[j];b+="<td>"+i.properties[k]+"</td>"}b+="</tr>"}b+="</tbody></table>"}}return b},_clearPopup:function(){this._popup&&(this._map.closePopup(this._popup),delete this._popup)},setActive:function(a){this._active=a,a?(this._map.on("click",this._getFeatureInfo,this),L.DomUtil.addClass(this._featureInfo,"leaflet-ss-control-feature-activated")):(this._clearPopup(),this._map.off("click",this._getFeatureInfo,this),L.DomUtil.removeClass(this._featureInfo,"leaflet-ss-control-feature-activated"))}}),L.SpectrumSpatial.Controls.feature=function(a,b,c){return new L.SpectrumSpatial.Controls.Feature(a,b,c)};