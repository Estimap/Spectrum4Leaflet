/*! Spectrum4Leaflet 10-02-2015 */
L.SpectrumSpatial={Version:"0.1.0",Services:{},Layers:{},Controls:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest)}},"undefined"!=typeof window&&window.L&&(window.L.SpectrumSpatial=L.SpectrumSpatial),L.SpectrumSpatial.Util={},function(){var a=0;window._Spectrum4LeafletCallbacks={},L.SpectrumSpatial.Request={_createRequest:function(a,b){var c=new XMLHttpRequest;return c.onerror=function(){a.call(b,{error:{code:500,message:"XMLHttpRequest error"}},null)},c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{var f=this.getResponseHeader("content-type");d="application/json"==f?JSON.parse(c.responseText):c.response}catch(g){d=null,e={code:500,message:"Could not parse response as JSON."}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c},get:function(a,b,c,d,e){var f=this._createRequest(d,e);return f.open("GET",a,!0,b,c),f.send(null),f},jsonp:function(b,c,d,e){var f="c"+a,g=L.DomUtil.create("script",null,document.body);return g.type="text/javascript",g.src=b+c+"callback=window._Spectrum4LeafletCallbacks."+f,g.id=f,window._Spectrum4LeafletCallbacks[f]=function(a){if(window._Spectrum4LeafletCallbacks[f]!==!0){var b,c=Object.prototype.toString.call(a);"[object Object]"!==c&&"[object Array]"!==c&&(b={error:{code:500,message:"Expected array or object as JSONP response"}},a=null),!b&&a.error&&(b=a,a=null),d.call(e,b,a),window._Spectrum4LeafletCallbacks[f]=!0}},a++,{id:f,url:g.src,abort:function(){window._Spectrum4LeafletCallbacks._callback[f]({code:0,message:"Request aborted."})}}},post:function(a,b,c,d,e,f,g,h){var i=this._createRequest(g,h);return i.open("POST",a,!0,e,f),i.setRequestHeader("Content-Type",c),d&&(i.responseType=d),i.send(b),i}}}(),L.SpectrumSpatial.Services.Operation=L.Class.extend({options:{forcePost:!1,paramsSeparator:";",queryStartCharacter:";",postType:"application/json",responseType:null},initialize:function(a,b){this.options.getParams={},this.options.postParams={},b=b||{},b.name=a,L.setOptions(this,b)},getUrlQuery:function(){var a=[],b=this.options.getParams;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];a.push(c+"="+encodeURIComponent(d))}var e=this.options.name;return a.length>0&&(e+=this.options.queryStartCharacter+a.join(this.options.paramsSeparator)),e},getPostData:function(){return JSON.stringify(this.options.postParams)},getPostType:function(){return this.options.postType},getResponseType:function(){return this.options.responseType},isPostOperation:function(){return 0!==Object.keys(this.options.postParams).length|this.options.forcePost}}),L.SpectrumSpatial.Services.operation=function(a,b){return new L.SpectrumSpatial.Services.Operation(a,b)},L.SpectrumSpatial.Services.Service=L.Class.extend({options:{alwaysUseProxy:!1,forceGet:!1,encodeUrlForProxy:!1},initialize:function(a,b){b=b||{},b.url=a,L.Util.setOptions(this,b)},startRequest:function(a,b,c){var d=this.getUrl(a);return a.isPostOperation()?(this.options.proxyUrl&&(d=this.options.proxyUrl+this.checkEncodeUrl(d)),L.SpectrumSpatial.Request.post(d,a.getPostData(),a.getPostType(),a.getResponseType(),this.options.login,this.options.password,b,c)):this.options.alwaysUseProxy?(d=this.options.proxyUrl+this.checkEncodeUrl(d),L.SpectrumSpatial.Request.get(d,this.options.login,this.options.password,b,c)):this.options.forceGet|L.SpectrumSpatial.Support.CORS?L.SpectrumSpatial.Request.get(d,this.options.login,this.options.password,b,c):L.SpectrumSpatial.Request.jsonp(d,"?",b,c)},getUrl:function(a){var b=this.clearParam(a.getUrlQuery()),c="/"===this.options.url.slice(-1)?"":"/";return this.options.url+c+b},clearParam:function(a){return"/"===a[0]&&(a=a.substring(1)),"/"===a.slice(-1)&&(a=a.substring(0,a.length-1)),a},checkEncodeUrl:function(a){return this.options.encodeUrlForProxy?encodeURIComponent(a):a}}),L.SpectrumSpatial.Services.service=function(a,b){return new L.SpectrumSpatial.Services.Service(a,b)},L.SpectrumSpatial.Services.MapService=L.SpectrumSpatial.Services.Service.extend({listNamedLayers:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("layers.json");this._addResolutionAndLocale(d,null,a),this.startRequest(d,b,c)},describeNamedLayer:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("layers/"+this.clearParam(a)+".json");this._addResolutionAndLocale(e,null,b),this.startRequest(e,c,d)},describeNamedLayers:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("layers.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");d.options.getParams.q="describe",e.length<1e3?d.options.getParams.layers=e:d.options.postParams={Layers:a},this.startRequest(d,b,c)},listNamedMaps:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("maps.json");this._addResolutionAndLocale(d,null,a),this.startRequest(d,b,c)},describeNamedMap:function(a,b,c,d){var e=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a)+".json");this._addResolutionAndLocale(e,null,b),this.startRequest(e,c,d)},describeNamedMaps:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("maps.json",{paramsSeparator:"&",queryStartCharacter:"?"}),e=a.join(",");e.length<1e3?(d.options.getParams.q="describe",d.options.getParams.maps=e):d.options.postParams={Maps:a},this.startRequest(d,b,c)},_createRenderOperation:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){a=this.clearParam(a),""!==a&&(a="/"+a);var q=new L.SpectrumSpatial.Services.Operation("maps"+a+"/image."+b,{responseType:"arraybuffer"});return q.options.getParams.w=c,q.options.getParams.h=d,e?q.options.getParams.b=e.join(",")+","+j:q.options.getParams.c=f+","+g+","+j,h&&(q.options.getParams.s=h),i&&(q.options.getParams.z=i),this._addResolutionAndLocale(q,k,l),m&&(q.options.getParams.rd=m),n&&(q.options.getParams.bc=n),o&&(q.options.getParams.bc=n),p&&(q.options.postParams=p),q},_addResolutionAndLocale:function(a,b,c){b&&(a.options.getParams.r=b),c&&(a.options.getParams.l=c)},renderMapByBounds:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=this._createRenderOperation(a,b,c,d,e,null,null,null,null,f,g,h,i,j,k,l);this.startRequest(o,m,n)},getUrlRenderMapByBounds:function(a,b,c,d,e,f,g,h,i,j,k){var l=this._createRenderOperation(a,b,c,d,e,null,null,null,null,f,g,h,i,j,k);return(this.options.alwaysUseProxy?this.options.proxyUrl:"")+this.checkEncodeUrl(this.getUrl(l))},renderMapByCenterScale:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this._createRenderOperation(a,b,c,d,null,e,f,g,null,h,i,j,k,l,m);this.startRequest(q,o,p)},getUrlRenderMapByCenterScale:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this._createRenderOperation(a,b,c,d,null,e,f,g,null,h,i,j,k,l,m);return this.getUrl(n)},renderMapByCenterZoom:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this._createRenderOperation(a,b,c,d,null,e,f,null,g,h,i,j,k,l,m);this.startRequest(q,o,p)},getUrlRenderMapByCenterZoom:function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this._createRenderOperation(a,b,c,d,null,e,f,null,g,h,i,j,k,l,m);return this.getUrl(n)},getLegendForMap:function(a,b,c,d,e,f,g,h,i){var j=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a)+"/legend.json");j.options.getParams.w=b,j.options.getParams.h=c,j.options.getParams.t=d,this._addResolutionAndLocale(j,f,g),null!==e&&(j.options.getParams["?inlineSwatch"]=e),this.startRequest(j,h,i)},getSwatchForLayer:function(a,b,c,d,e,f,g,h,i,j){var k=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a)+"/legends/"+b+"/rows/"+c+"/swatch/"+d+"x"+e+"."+f);this._addResolutionAndLocale(k,g,h),this.startRequest(k,i,j)},getUrlSwatchForLayer:function(a,b,c,d,e,f,g,h){var i=new L.SpectrumSpatial.Services.Operation("maps/"+this.clearParam(a)+"/legends/"+b+"/rows/"+c+"/swatch/"+d+"x"+e+"."+f);return this._addResolutionAndLocale(i,g,h),this.getUrl(i)},renderLegend:function(){}}),L.SpectrumSpatial.Services.mapService=function(a,b){return new L.SpectrumSpatial.Services.MapService(a,b)},L.SpectrumSpatial.Services.TileService=L.SpectrumSpatial.Services.Service.extend({mapList:function(a,b){var c=new L.SpectrumSpatial.Services.Operation("mapList.json");this.startRequest(c,a,b)},description:function(a,b,c){var d=new L.SpectrumSpatial.Services.Operation("/"+this.clearParam(a)+"/description.json");this.startRequest(d,b,c)},getTileUrl:function(a,b,c,d,e){var f=this._createTileOperation(a,b,c,d,e);return(this.options.alwaysUseProxy?this.options.proxyUrl:"")+this.checkEncodeUrl(this.getUrl(f))},getTile:function(a,b,c,d,e,f,g){var h=this._createTileOperation(a,b,c,d,e);this.startRequest(h,f,g)},_createTileOperation:function(a,b,c,d,e){return a=this.clearParam(a),""!==a&&(a="/"+a),new L.SpectrumSpatial.Services.Operation(a+"/"+b+"/"+c+":"+d+"/tile."+e)}}),L.SpectrumSpatial.Services.tileService=function(a,b){return new L.SpectrumSpatial.Services.TileService(a,b)},L.SpectrumSpatial.Layers.MapServiceLayer=L.Layer.extend({options:{opacity:1,alt:"",interactive:!1,imageType:"png",zIndex:"auto",updateInterval:200},initialize:function(a,b,c,d){this._mapName=b,this._service=a,this._postData=c,L.setOptions(this,d)},onAdd:function(a){this._map=a,this._srs=a.options.crs,this._update=L.Util.throttle(this._update,this.options.updateInterval,this),a.on("moveend",this._update,this),this._update()},onRemove:function(){L.DomUtil.remove(this._image)},setService:function(a){return this._service=a,this._update(),this},setMapName:function(a){return this._mapName=a,this._update(),this},setPostData:function(a){return this._postData=a,this._update(),this},setOpacity:function(a){return this.options.opacity=a,this._image&&this._updateOpacity(),this},setStyle:function(a){return a.opacity&&this.setOpacity(a.opacity),this},setZIndex:function(a){return this.options.zIndex=a,this._updateZIndex(),this},getZIndex:function(){return this.options.zIndex},bringToFront:function(){return this._map&&L.DomUtil.toFront(this._image),this},bringToBack:function(){return this._map&&L.DomUtil.toBack(this._image),this},getAttribution:function(){return this.options.attribution},getEvents:function(){var a={viewreset:this._reset};return this._zoomAnimated&&(a.zoomanim=this._animateZoom),a},getBounds:function(){return this._bounds},_initInteraction:function(){this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),L.DomEvent.on(this._image,"click dblclick mousedown mouseup mouseover mousemove mouseout contextmenu",this._fireMouseEvent,this))},_fireMouseEvent:function(a,b){this._map&&this._map._fireMouseEvent(this,a,b,!0)},_initImage:function(){var a=L.DomUtil.create("img","leaflet-image-layer "+(this._zoomAnimated?"leaflet-zoom-animated":""));return a.onselectstart=L.Util.falseFn,a.onmousemove=L.Util.falseFn,a.style.zIndex=this.options.zIndex,a.alt=this.options.alt,this.options.opacity<1&&L.DomUtil.setOpacity(a,this.options.opacity),a},_requestCounter:0,_animateZoom:function(a){var b=new L.Bounds(this._map._latLngToNewLayerPoint(this._bounds.getNorthWest(),a.zoom,a.center),this._map._latLngToNewLayerPoint(this._bounds.getSouthEast(),a.zoom,a.center)),c=b.min.add(b.getSize()._multiplyBy((1-1/a.scale)/2));L.DomUtil.setTransform(this._image,c,a.scale)},_reset:function(){var a=this._image,b=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),c=b.getSize();L.DomUtil.setPosition(a,b.min),a.style.width=c.x+"px",a.style.height=c.y+"px"},_update:function(){if(!(this._map._animatingZoom||this._map._panAnim&&this._map._panAnim._inProgress)){var a=this._map.getBounds(),b=this._map.getSize(),c=this._srs.project(a.getNorthWest()),d=this._srs.project(a.getSouthEast()),e=this._initImage();this._requestCounter++,this._postData?this._service.renderMapByBounds(this._mapName,this.options.imageType,b.x,b.y,[c.x,c.y,d.x,d.y],this._srs.code,null,null,null,null,null,this._postData,this._postLoad,{context:this,image:e,bounds:a,counter:this._requestCounter}):(e.onload=L.bind(this._afterLoad,this,{image:e,bounds:a,counter:this._requestCounter}),e.src=this._service.getUrlRenderMapByBounds(this._mapName,this.options.imageType,b.x,b.y,[c.x,c.y,d.x,d.y],this._srs.code)),this.fire("loading")}},_afterLoad:function(a){if(this._requestCounter!=a.counter)return void delete a.image;this.fire("load"),this._bounds=a.bounds,this._size=this._map.getSize();var b=a.image,c=new L.Bounds(this._map.latLngToLayerPoint(this._bounds.getNorthWest()),this._map.latLngToLayerPoint(this._bounds.getSouthEast())),d=c.getSize();L.DomUtil.setPosition(b,c.min),b.style.width=d.x+"px",b.style.height=d.y+"px",this.getPane(this.options.pane).appendChild(b),this._image&&(this.getPane(this.options.pane).removeChild(this._image),L.DomEvent.off(this._image,"click dblclick mousedown mouseup mouseover mousemove mouseout contextmenu",this._fireMouseEvent,this),delete this._image),this._image=b,this._initInteraction()},_postLoad:function(a,b){for(var c=new Uint8Array(b),d=c.length,e=new Array(d);d--;)e[d]=String.fromCharCode(c[d]);var f=e.join(""),g=window.btoa(f);this.image.src="data:image/png;base64,"+g,this.context._afterLoad({image:this.image,bounds:this.bounds,counter:this.counter})},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity)},_updateZIndex:function(){this._image.style.zIndex=this.options.zIndex}}),L.SpectrumSpatial.Layers.mapServiceLayer=function(a,b,c,d){return new L.SpectrumSpatial.Layers.MapServiceLayer(a,b,c,d)},L.SpectrumSpatial.Layers.TileServiceLayer=L.GridLayer.extend({options:{maxZoom:18,minZoom:0,errorTileUrl:"",zoomOffset:0,maxNativeZoom:null,tms:!1,zoomReverse:!1,detectRetina:!1,crossOrigin:!1},initialize:function(a,b,c){this._service=a,this._mapName=b,c=L.setOptions(this,c),c.detectRetina&&L.Browser.retina&&c.maxZoom>0&&(c.tileSize=Math.floor(c.tileSize/2),c.zoomOffset++,c.minZoom=Math.max(0,c.minZoom),c.maxZoom--),L.Browser.android||this.on("tileunload",this._onTileRemove)},setService:function(a,b){return this._service=a,b||this.redraw(),this},setMapName:function(a,b){return this._mapName=a,b||this.redraw(),this},createTile:function(a,b){var c=document.createElement("img");return c.onload=L.bind(this._tileOnLoad,this,b,c),c.onerror=L.bind(this._tileOnError,this,b,c),this.options.crossOrigin&&(c.crossOrigin=""),c.alt="",c.src=this.getTileUrl(a),c},getTileUrl:function(a){return this._service.getTileUrl(this._mapName,this._getZoomForUrl()+1,a.x+1,(this.options.tms?this._globalTileRange.max.y-a.y:a.y)+1,"png")},_tileOnLoad:function(a,b){a(null,b)},_tileOnError:function(a,b,c){var d=this.options.errorTileUrl;d&&(b.src=d),a(c,b)},_getTileSize:function(){var a=this._map,b=this.options,c=a.getZoom()+b.zoomOffset,d=b.maxNativeZoom;return null!==d&&c>d?Math.round(a.getZoomScale(d,c)*b.tileSize):b.tileSize},_onTileRemove:function(a){a.tile.onload=null},_getZoomForUrl:function(){var a=this.options,b=this._tileZoom;return a.zoomReverse&&(b=a.maxZoom-b),b+=a.zoomOffset,a.maxNativeZoom?Math.min(b,a.maxNativeZoom):b},_abortLoading:function(){var a,b;for(a in this._tiles)b=this._tiles[a].el,b.onload=L.Util.falseFn,b.onerror=L.Util.falseFn,b.complete||(b.src=L.Util.emptyImageUrl,L.DomUtil.remove(b))}}),L.SpectrumSpatial.Layers.tileServiceLayer=function(a,b,c){return new L.SpectrumSpatial.Layers.TileServiceLayer(a,b,c)};